---
layout: post
title: OkHttp3
---
# OkHttp是一个精巧的网络请求库，有如下特性  
> 
  * (1)支持http2，对一台机器的所有请求共享同一个socket  
  * (2)内置连接池，支持连接复用，减少延迟  
  * (3)支持透明的gzip压缩响应体  
  * (4)通过缓存避免重复的请求  
  * (5)请求失败时自动重试主机的其他ip，自动重定向  
  * (6)好用的API  
> 
  代码  OkHttpClient必须是单例的  

  ```  
  String url = "http://write.blog.csdn.net/postlist/0/0/enabled/1";
    mHttpClient = new OkHttpClient();

    Request request = new Request.Builder().url(url).build();
    okhttp3.Response response = null;
    try {

            response = mHttpClient.newCall(request).execute();
            String json = response.body().string();
            Log.d("okHttp",json);

    } catch (IOException e) {
        e.printStackTrace();
    }  
   ```  
  
# Dispatcher任务调度
 * 请求是dispatcher来完成的,Dispatcher的本质是异步请求的管理器，控制最大请求并发数和单个主机的最大并发数，并持有一个线程池负责执行异步请求。对同步的请求只是用作统计。他是如何做到控制并发呢，其实原理就在上面的2个execute代码里面,真正网络请求执行前后会调用executed和finished方法，而对于AsyncCall的finished方法后，会根据当前并发数目选择是否执   
 # Chain与Interceptor会互相递归调用，直到链的尽头.通过职责链模式,大概流程是:  
  * (1)先经过用户拦截器  
  * (2)RetryAndFollowUpInterceptor负责自动重试和进行必要的重定向  
  * (3)BridgeIntercetor负责将用户Request转换成一个实际的网络请求的Request，再调用下层的拦截器获取Response，最后再将网络Response转换成用户的Reponse  
  * (4)CacheInterceptor负责控制缓存  
  * (5)ConnectInterceptor负责进行连接主机  
  * (6)网络拦截器进行拦截  
  * (7)CallServerInterceptor是真正和服务器通信，完成http请求连接与通信  在RetryAndFollowUpInterceptor中,会创建StreamAllocation，然后交给下游的ConnectInterceptor  
> 
```
Override public Response intercept(Chain chain) throws IOException {
  RealInterceptorChain realChain = (RealInterceptorChain) chain;
  Request request = realChain.request();
  StreamAllocation streamAllocation = realChain.streamAllocation();

  // We need the network to satisfy this request. Possibly for validating a conditional GET.
  boolean doExtensiveHealthChecks = !request.method().equals("GET");
  HttpStream httpStream = streamAllocation.newStream(client, doExtensiveHealthChecks);
  RealConnection connection = streamAllocation.connection();

  return realChain.proceed(request, streamAllocation, httpStream, connection);
}  
```    
# [ 相关文档链接 ](https://www.cnblogs.com/ldq2016/category/1196766.html)
