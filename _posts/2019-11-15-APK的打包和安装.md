---
layout: post
title: APK的打包和安装
---
# APK的打包
Android的包文件APK分为两个部分：代码和资源，所以打包方面也分为资源打包和代码打包两个方面，这篇文章就来分析资源和代码的编译打包原理。

* 1.通过AAPT工具进行资源文件（包括AndroidManifest.xml、布局文件、各种xml资源等）的打包，生成R.java文件。

* 2.通过AIDL工具处理AIDL文件，生成相应的Java文件。

* 3.通过Javac工具编译项目源码，生成Class文件。

* 4.通过DX工具将所有的Class文件转换成DEX文件，该过程主要完成Java字节码转换成Dalvik字节码，压缩常量池以及清除冗余信息等工作。

* 5.通过ApkBuilder工具将资源文件、DEX文件打包生成APK文件。

* 6.利用KeyStore对生成的APK文件进行签名。

* 7.如果是正式版的APK，还会利用ZipAlign工具进行对齐处理，对齐的过程就是将APK文件中所有的资源文件举例文件的起始距离都偏移4字节的整数倍，这样通过内存映射访问APK文件
的速度会更快。

> 在第4步，将class文件转换成dex文件，默认只会生成一个dex文件，单个dex文件中的方法数不能超过65536，不然编译会报错：***Unable to execute dex: method ID not in [0, 0xffff]: 65536*** App集成一堆库之后，方法数一般都是超过65536的，解决办法就是：一个dex装不下，用多个dex来装，gradle增加一行配置即可。***multiDexEnabled true*** 这样解决了编译问题，在5.0以上手机运行正常，但是5.0以下手机运行直接crash，报错 Class NotFound xxx。Android 5.0以下，ClassLoader加载类的时候只会从class.dex（主dex）里加载，ClassLoader不认识其它的class2.dex、class3.dex、...，当访问到不在主dex中的类的时候，就会报错:Class NotFound xxx，因此谷歌给出兼容方案，MultiDex。MultiDex.install

参考[ 今日头条启动很快优化 ](https://mp.weixin.qq.com/s/N3vp91usxclib1NuGEuPgA)

# APK的安装流程  
复制APK到/data/app目录下，解压并扫描安装包。

* 1.资源管理器解析APK里的资源文件。

* 2.解析AndroidManifest文件，并在/data/data/目录下创建对应的应用数据目录。

* 3.然后对dex文件进行优化，并保存在dalvik-cache目录下。

* 4.将AndroidManifest文件解析出的四大组件信息注册到PackageManagerService中。

* 5.安装完成后，发送广播。

